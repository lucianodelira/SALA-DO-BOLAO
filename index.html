<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sala Exclusiva</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#00c853">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
import { getMessaging, getToken, onMessage } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-messaging.js";

const firebaseConfig = {
  apiKey: "AIzaSyA7PTBoaKVAxXrpBNWSzbin5XGkbQBGrWY",
  authDomain: "sala-bolao.firebaseapp.com",
  projectId: "sala-bolao",
  storageBucket: "sala-bolao.appspot.com",
  messagingSenderId: "19354677995",
  appId: "1:19354677995:web:374ae89b72107e8b0844ae",
  measurementId: "G-C09QTEFN5L"
};

const app = initializeApp(firebaseConfig);
const messaging = getMessaging(app);

window.messaging = messaging;
window.getToken = getToken;
window.onMessage = onMessage;

const API_URL = 'https://script.google.com/macros/s/AKfycbz4kDF2DyJxIy7kH7-BTtkPhwFLDyXHAXiMVxlUnRdViYOjz9LUbh9AGJSLxpODG4_vMw/exec';

// ==========================================
// SERVICE WORKER
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('sw.js').then(reg => console.log('SW registrado', reg)).catch(console.error);
}

// ==========================================
// PERMISSÃƒO DE NOTIFICAÃ‡Ã•ES
Notification.requestPermission().then(p => {
  if (p === 'granted') console.log('PermissÃ£o de notificaÃ§Ãµes concedida');
  else console.warn('PermissÃ£o negada');
});

// ==========================================
// RECEBER NOTIFICAÃ‡Ã•ES EM FOREGROUND
window.onMessage(messaging, payload => {
  console.log('Mensagem FCM recebida:', payload);
  const title = payload.notification?.title || "Nova mensagem";
  const body = payload.notification?.body || payload.data?.mensagem || "";

  // NotificaÃ§Ã£o visual
  new Notification(title, { body, icon: 'icon.png' });

  // Som
  const audio = new Audio('alerta.mp3');
  audio.play().catch(err => console.error('Erro tocar som:', err));
});

// ==========================================
// REGISTRAR TOKEN FCM
function inscreverNoTopic() {
  getToken(messaging, { vapidKey: 'pvhHVsA80Jy8AqtM52PtxdhApalEYg_hZTL6hN3Pve4' })
    .then(token => {
      if (!token) return console.warn('Token FCM nÃ£o obtido');
      console.log('Token FCM:', token);

      fetch(`${API_URL}?action=registrarToken`, {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({
          userId: sessionStorage.getItem('userId'),
          nome: sessionStorage.getItem('userNome'),
          fcmToken: token
        })
      }).then(r => r.json()).then(res => console.log('Token registrado:', res))
        .catch(err => console.error('Erro registrar token:', err));
    }).catch(err => console.error('Erro getToken:', err));
}
window.inscreverNoTopic = inscreverNoTopic;
</script>

<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:Poppins,sans-serif;background:linear-gradient(135deg,#0f0c29,#302b63,#24243e);color:#fff;min-height:100vh;display:flex;justify-content:center;align-items:center;}
.container{width:100%;max-width:1000px;background:rgba(28,28,44,.85);border-radius:20px;padding:30px;}
h2,h3{color:#00ff88;text-align:center}
.subtitle{text-align:center;color:#ccc;margin-bottom:15px}
input,button{width:100%;padding:12px;border-radius:10px;border:none;margin-top:8px;}
input{background:#1f1f3a;color:#fff}
button{background:linear-gradient(90deg,#00c853,#00ff88);font-weight:700;cursor:pointer;}
.hidden{display:none}
.info-card{background:rgba(0,200,83,.08);border:1px solid rgba(0,200,83,.25);border-radius:16px;padding:18px;margin:12px 0;}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;}
.logout{background:linear-gradient(90deg,#ff5252,#ff7675);}
#listaParticipantes{max-height:200px;overflow:auto;font-size:14px;}
iframe{width:100%;height:350px;border:none;border-radius:12px;}
.chat-box{height:220px;overflow-y:auto;background:#14142a;padding:10px;border-radius:10px;font-size:14px;}
.chat-msg{margin-bottom:6px}
.chat-name{color:#00ff88;font-weight:600}
#installBanner{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:#00c853;color:#000;padding:12px 18px;border-radius:18px;display:none;align-items:center;gap:12px;font-weight:700;z-index:9999;box-shadow:0 6px 25px rgba(0,0,0,.5);}
#installBanner button{background:#000;color:#00ff88;border:none;padding:6px 12px;border-radius:12px;font-weight:700;}
</style>
</head>

<body>
<div id="installBanner">
  <span>ðŸ“² Baixar App</span>
  <button onclick="instalarApp()">Instalar</button>
</div>

<div class="container" id="loginBox">
  <h2>Entrar na Sala</h2>
  <p class="subtitle">Acesso exclusivo</p>
  <input id="nome" placeholder="Nome completo">
  <input id="telefone" placeholder="Telefone com DDD">
  <button onclick="login()">Entrar</button>
  <p id="msg" style="color:#ff6b6b;text-align:center"></p>
</div>

<div class="container hidden" id="salaBox">
  <div class="info-card">
    <h3>Participantes Ativos</h3>
    <h2 id="totalAtivos">0</h2>
    <button onclick="abrirIframe()">Abrir Site</button>
  </div>
  <div class="grid">
    <div class="info-card">
      <h3>ðŸ‘¥ Participantes</h3>
      <div id="listaParticipantes"></div>
    </div>
    <div class="info-card">
      <h3>ðŸŽ¯ BolÃ£o</h3>
      <button onclick="participarBolao()">Participar</button>
      <button onclick="exibirBolao()">Exibir</button>
    </div>
  </div>
  <div class="info-card">
    <h3>ðŸ’¬ Chat da Sala</h3>
    <div class="chat-box" id="chatBox"></div>
    <input id="chatMsg" placeholder="Digite sua mensagem">
    <button onclick="enviarMsg()">Enviar</button>
  </div>
  <div class="info-card hidden" id="iframeBox">
    <button class="logout" onclick="fecharIframe()">Fechar</button>
    <iframe src="https://www.zepitaco.com"></iframe>
  </div>
  <button class="logout" onclick="logout()">Sair</button>
</div>

<script>
// ==========================================
// BANNER INSTALAR
let deferredPrompt;
window.addEventListener('beforeinstallprompt', e => { e.preventDefault(); deferredPrompt=e; document.getElementById('installBanner').style.display='flex'; });
function instalarApp() { document.getElementById('installBanner').style.display='none'; if(deferredPrompt){ deferredPrompt.prompt(); deferredPrompt.userChoice.then(()=>deferredPrompt=null); } }
window.addEventListener('appinstalled', ()=>document.getElementById('installBanner').style.display='none');

// ==========================================
// LOGIN
function login() {
  const nome = document.getElementById('nome').value.trim();
  const telefone = document.getElementById('telefone').value.trim();
  const msg = document.getElementById('msg');
  if(!nome||!telefone){ msg.innerText="Preencha nome e telefone"; return; }

  fetch(`${API_URL}?action=loginSala&nome=${encodeURIComponent(nome)}&telefone=${encodeURIComponent(telefone)}`)
    .then(r=>r.json())
    .then(res=>{
      if(res.success){ sessionStorage.setItem('userId',res.id); sessionStorage.setItem('userNome',res.nome); entrarSala(); }
      else msg.innerText=res.message||"Acesso negado";
    }).catch(err=>{ msg.innerText="Erro de conexÃ£o"; console.error(err); });
}

function entrarSala() {
  document.getElementById('loginBox').classList.add('hidden');
  document.getElementById('salaBox').classList.remove('hidden');
  carregarSala(); carregarChat(); inscreverNoTopic();
}

// ==========================================
// SALA / CHAT
function carregarSala() {
  fetch(`${API_URL}?action=dashboard`).then(r=>r.json()).then(d=>{
    document.getElementById('totalAtivos').innerText=d.totalAtivos;
    document.getElementById('listaParticipantes').innerHTML=d.participantes.join('<br>');
  });
}

function carregarChat() {
  setInterval(()=>{
    fetch(`${API_URL}?action=getChat`).then(r=>r.json()).then(msgs=>{
      const chatBox=document.getElementById('chatBox'); chatBox.innerHTML='';
      msgs.forEach(m=>chatBox.innerHTML+=`<div class="chat-msg"><span class="chat-name">${m.nome}:</span> ${m.msg}</div>`);
      chatBox.scrollTop=chatBox.scrollHeight;
    });
  },3000);
}

function enviarMsg() {
  const input=document.getElementById('chatMsg'); const msg=input.value.trim();
  if(!msg) return;
  fetch(`${API_URL}?action=sendChat&nome=${encodeURIComponent(sessionStorage.getItem('userNome'))}&msg=${encodeURIComponent(msg)}`);
  input.value='';
}

function abrirIframe(){document.getElementById('iframeBox').classList.remove('hidden');}
function fecharIframe(){document.getElementById('iframeBox').classList.add('hidden');}
function participarBolao(){alert('VocÃª entrou no bolÃ£o');}
function exibirBolao(){alert('BolÃ£o exibido');}
function logout(){sessionStorage.clear(); location.reload();}
if(sessionStorage.getItem('userId')) entrarSala();




// Receber mensagens em foreground
window.onMessage(window.messaging, payload => {
  const title = payload.notification?.title || "Nova mensagem";
  const body = payload.notification?.body || payload.data?.mensagem || "";

  new Notification(title, { body, icon: 'icon.png' });

  // Som de alerta
  const audio = new Audio('alerta.mp3');
  audio.play().catch(err => console.warn('Erro tocar som:', err));
});




  
</script>
</body>
</html>
