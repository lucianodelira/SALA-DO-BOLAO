<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sala Exclusiva</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#00c853">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:Poppins,sans-serif;background:linear-gradient(135deg,#0f0c29,#302b63,#24243e);color:#fff;min-height:100vh;display:flex;justify-content:center;align-items:center;}
.container{width:100%;max-width:1000px;background:rgba(28,28,44,.85);border-radius:20px;padding:30px;}
h2,h3{color:#00ff88;text-align:center}
.subtitle{text-align:center;color:#ccc;margin-bottom:15px}
input,button{width:100%;padding:12px;border-radius:10px;border:none;margin-top:8px;}
input{background:#1f1f3a;color:#fff}
button{background:linear-gradient(90deg,#00c853,#00ff88);font-weight:700;cursor:pointer;}
.hidden{display:none}
.info-card{background:rgba(0,200,83,.08);border:1px solid rgba(0,200,83,.25);border-radius:16px;padding:18px;margin:12px 0;}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;}
.logout{background:linear-gradient(90deg,#ff5252,#ff7675);}
#listaParticipantes{max-height:200px;overflow:auto;font-size:14px;}
iframe{width:100%;height:350px;border:none;border-radius:12px;}
.chat-box{height:220px;overflow-y:auto;background:#14142a;padding:10px;border-radius:10px;font-size:14px;}
.chat-msg{margin-bottom:6px}
.chat-name{color:#00ff88;font-weight:600}
#toast{position:fixed;top:20px;right:20px;background:#00c853;color:#000;padding:14px 20px;border-radius:14px;font-weight:700;display:none;z-index:9999;}
#installBanner{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:#00c853;color:#000;padding:12px 18px;border-radius:18px;display:none;gap:12px;font-weight:700;z-index:9999;}
#installBanner button{background:#000;color:#00ff88;border:none;padding:6px 12px;border-radius:12px;font-weight:700;}
</style>
</head>
<body>

  
  
  
  
  
  
  
  
  
  
  
  
<div id="installBanner">
  <span>Instale o app na sua tela inicial!</span>
  <button>Instalar</button>
</div>  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  <div id="toast"></div>
<div class="container" id="loginBox">
  <h2>Entrar na Sala</h2>
  <p class="subtitle">Acesso exclusivo</p>
  <input id="nome" placeholder="Nome completo">
  <input id="telefone" placeholder="Telefone com DDD">
  <button onclick="login()">Entrar</button>
  <p id="msg" style="color:#ff6b6b;text-align:center"></p>
</div>
<div class="container hidden" id="salaBox">
  <div class="info-card">
    <h3>Participantes Ativos</h3>
    <h2 id="totalAtivos">0</h2>
    <button onclick="abrirIframe()">Abrir Site</button>
  </div>
  <div class="grid">
    <div class="info-card">
      <h3>ðŸ‘¥ Participantes</h3>
      <div id="listaParticipantes"></div>
    </div>
    <div class="info-card">
      <h3>ðŸŽ¯ BolÃ£o</h3>
      <button onclick="participarBolao()">Participar</button>
      <button onclick="exibirBolao()">Exibir</button>
    </div>
  </div>
  <div class="info-card">
    <h3>ðŸ’¬ Chat da Sala</h3>
    <div class="chat-box" id="chatBox"></div>
    <input id="chatMsg" placeholder="Digite sua mensagem">
    <button onclick="enviarMsg()">Enviar</button>
  </div>
  <div class="info-card hidden" id="iframeBox">
    <button class="logout" onclick="fecharIframe()">Fechar</button>
    <iframe src="https://www.zepitaco.com"></iframe>
  </div>
  <button class="logout" onclick="logout()">Sair</button>
</div>

<script>
// =============================================
// CONFIGURAÃ‡Ã•ES GLOBAIS
const API_URL = 'https://script.google.com/macros/s/AKfycbz4kDF2DyJxIy7kH7-BTtkPhwFLDyXHAXiMVxlUnRdViYOjz9LUbh9AGJSLxpODG4_vMw/exec';

let totalMensagens = 0;
let carregouChat = false;
let audioLiberado = false;

const somMensagem = new Audio('sons/beep.mp3');
somMensagem.volume = 1;

// =============================================
// NOTIFICAÃ‡ÃƒO NATIVA DO NAVEGADOR
if ("Notification" in window && Notification.permission !== "granted") {
  Notification.requestPermission();
}

function liberarSom() {
  if (audioLiberado) return;
  somMensagem.play().then(() => {
    somMensagem.pause();
    somMensagem.currentTime = 0;
    audioLiberado = true;
  }).catch(() => {});
}

// =============================================
// LOGIN
function login() {
  liberarSom();
  const nomeEl = document.getElementById('nome');
  const telEl = document.getElementById('telefone');
  const msgEl = document.getElementById('msg');

  fetch(`${API_URL}?action=loginSala&nome=${encodeURIComponent(nomeEl.value)}&telefone=${encodeURIComponent(telEl.value)}`)
    .then(r => r.json())
    .then(res => {
      if (res.success) {
        sessionStorage.setItem('userNome', res.nome);
        entrarSala();
      } else {
        msgEl.innerText = res.message || 'Acesso negado';
      }
    })
    .catch(() => msgEl.innerText = 'Erro na conexÃ£o');
}

function entrarSala() {
  document.getElementById('loginBox').classList.add('hidden');
  document.getElementById('salaBox').classList.remove('hidden');
  carregarSala();
  carregarChat();
  iniciarFirebaseEMensagens();   // â† aqui comeÃ§a a parte do FCM
}

// =============================================
// DASHBOARD E CHAT (mantido igual, sÃ³ organizei)
function carregarSala() {
  fetch(`${API_URL}?action=dashboard`)
    .then(r => r.json())
    .then(d => {
      document.getElementById('totalAtivos').innerText = d.totalAtivos;
      document.getElementById('listaParticipantes').innerHTML = d.participantes.join('<br>');
    })
    .catch(err => console.log('Erro ao carregar dashboard', err));
}

function carregarChat() {
  setInterval(() => {
    fetch(`${API_URL}?action=getChat`)
      .then(r => r.json())
      .then(msgs => {
        const chatBox = document.getElementById('chatBox');
        chatBox.innerHTML = '';
        msgs.forEach(m => {
          chatBox.innerHTML += `<div class="chat-msg"><span class="chat-name">${m.nome}:</span> ${m.msg}</div>`;
        });

        if (carregouChat && msgs.length > totalMensagens) {
          notificar(msgs[msgs.length - 1]);
        }

        carregouChat = true;
        totalMensagens = msgs.length;
        chatBox.scrollTop = chatBox.scrollHeight;
      })
      .catch(err => console.log('Erro ao carregar chat', err));
  }, 3000);
}

function notificar(msg) {
  if (audioLiberado) {
    somMensagem.currentTime = 0;
    somMensagem.play().catch(() => {});
  }
  if (navigator.vibrate) navigator.vibrate([200, 100, 200]);

  if (Notification.permission === "granted" && document.hidden) {
    new Notification("ðŸ’¬ Nova mensagem", {
      body: `${msg.nome}: ${msg.msg}`
    });
  }

  const toast = document.getElementById('toast');
  toast.innerText = `ðŸ’¬ ${msg.nome}: ${msg.msg}`;
  toast.style.display = 'block';
  setTimeout(() => toast.style.display = 'none', 4000);
}

function enviarMsg() {
  const input = document.getElementById('chatMsg');
  if (!input.value.trim()) return;

  const nome = sessionStorage.getItem('userNome');
  fetch(`${API_URL}?action=sendChat&nome=${encodeURIComponent(nome)}&msg=${encodeURIComponent(input.value)}`)
    .then(() => input.value = '')
    .catch(err => console.log('Erro ao enviar mensagem', err));
}

// =============================================
// FUNÃ‡Ã•ES AUXILIARES
function abrirIframe() { document.getElementById('iframeBox').classList.remove('hidden'); }
function fecharIframe() { document.getElementById('iframeBox').classList.add('hidden'); }
function participarBolao() { alert('VocÃª entrou no bolÃ£o'); }
function exibirBolao() { alert('BolÃ£o exibido'); }
function logout() { sessionStorage.clear(); location.reload(); }

// =============================================
// FIREBASE â€“ CLIENT SIDE (corrigido)
function iniciarFirebaseEMensagens() {
  // Carrega o Firebase de forma compatÃ­vel (sem type="module")
  const script = document.createElement('script');
  script.src = "https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js";
  script.onload = () => {
    const messagingScript = document.createElement('script');
    messagingScript.src = "https://www.gstatic.com/firebasejs/10.14.1/firebase-messaging-compat.js";
    messagingScript.onload = inicializarFirebase;
    document.head.appendChild(messagingScript);
  };
  document.head.appendChild(script);
}

function inicializarFirebase() {
  const firebaseConfig = {
    apiKey:            "AIzaSyA7PTBoaKVAxXrpBNWSzbin5XGkbQBGrWY",
    authDomain:        "sala-bolao.firebaseapp.com",
    projectId:         "sala-bolao",
    storageBucket:     "sala-bolao.appspot.com",
    messagingSenderId: "19354677995",
    appId:             "1:19354677995:web:374ae89b72107e8b0844ae",
    measurementId:     "G-C09QTEFN5L"
  };

  firebase.initializeApp(firebaseConfig);
  const messaging = firebase.messaging();

  // Solicita permissÃ£o e obtÃ©m token + inscriÃ§Ã£o no topic
  Notification.requestPermission().then(permission => {
    if (permission === 'granted') {
      console.log('PermissÃ£o de notificaÃ§Ã£o concedida');

      messaging.getToken({ vapidKey: 'pvhHVsA80Jy8AqtM52PtxdhApalEYg_hZTL6hN3Pve4' })
        .then(currentToken => {
          if (currentToken) {
            console.log('FCM Token gerado:', currentToken);

            // Inscreve no topic (mÃ©todo correto do SDK compat)
            messaging.subscribeToTopic(currentToken, 'sala-bolao')
              .then(() => {
                console.log('Inscrito com sucesso no topic: sala-bolao');
              })
              .catch(err => {
                console.error('Erro ao inscrever no topic:', err);
              });

            // Opcional: enviar o token para o backend
            // fetch(`${API_URL}?action=saveToken&token=${currentToken}&nome=${sessionStorage.getItem('userNome')}`);
          } else {
            console.log('NÃ£o foi possÃ­vel obter token FCM');
          }
        })
        .catch(err => {
          console.error('Erro ao obter token FCM:', err);
        });
    }
  });

  // Recebe mensagens em foreground
  messaging.onMessage(payload => {
    console.log('Mensagem recebida em foreground:', payload);
    const notificationTitle = payload.notification?.title || 'Nova mensagem na sala';
    const notificationOptions = {
      body: payload.notification?.body || '',
      icon: '/icon.png'  // coloque um Ã­cone se tiver
    };
    new Notification(notificationTitle, notificationOptions);
  });
}



// Banner de instalaÃ§Ã£o manual
let deferredPrompt;

window.addEventListener('beforeinstallprompt', (e) => {
  // Impede o banner automÃ¡tico do Chrome
  e.preventDefault();
  deferredPrompt = e;
  
  // Mostra seu banner personalizado
  const installBanner = document.getElementById('installBanner');
  installBanner.style.display = 'flex';
});

document.getElementById('installBanner')?.querySelector('button').addEventListener('click', async () => {
  if (deferredPrompt) {
    deferredPrompt.prompt();
    const { outcome } = await deferredPrompt.userChoice;
    if (outcome === 'accepted') {
      console.log('PWA instalado pelo usuÃ¡rio');
    }
    deferredPrompt = null;
    document.getElementById('installBanner').style.display = 'none';
  }
});

 // Registrar o Service Worker (obrigatÃ³rio para notificaÃ§Ãµes em background)
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('firebase-messaging-sw.js')  // â† ajuste o nome se for diferente
      .then(registration => {
        console.log('Service Worker registrado com sucesso:', registration.scope);
      })
      .catch(err => {
        console.error('Falha ao registrar Service Worker:', err);
      });
  });
} 
</script>
</body>
</html>
